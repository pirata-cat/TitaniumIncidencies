function ReportWindow(e){Ti.App.dB.open();var t=Ti.UI.createWindow({title:e,backgroundColor:"black",backgroundImage:"images/background.png",layout:"vertical",orientationModes:[]});t.createLabel=function(e){return Ti.UI.createLabel({height:44,width:"auto",left:10,top:5,textAlign:Ti.UI.TEXT_ALIGNMENT_LEFT,text:e,color:"white"})},t.createTextField=function(e,t){return Ti.UI.createTextField({height:44,left:10,right:10,borderStyle:Ti.UI.INPUT_BORDERSTYLE_ROUNDED,textAlign:Ti.UI.TEXT_ALIGNMENT_LEFT,value:e,hintText:t,clearButtonMode:Ti.UI.INPUT_BUTTONMODE_ONFOCUS})},t.createPicker=function(e,t,a,r){var i="50";"iPhone OS"==Titanium.Platform.name&&(i="200");var o=Ti.UI.createView({height:i});return o.onChangeEvent=t,o.setSelectedValue=function(e){o.valor=e},o.setSelectedRow=function(e,t){null!=o.picker&&o.picker.setSelectedRow(e,t)},o.ucFirstLowerRest=function(e){return e+="",e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()},o.resetPicker=function(e){null!=o.picker&&(o.remove(o.picker),o.picker=null);var t=Ti.UI.createPicker({left:10,right:10,type:Ti.UI.PICKER_TYPE_PLAIN});o.picker=t,o.add(t);var i="";null!=r&&(i=r),t.add(Ti.UI.createPickerRow({title:i+"                                                        ",valor:""}));var n=null,l=[],c=0;for(var d in e)n=1!=a?o.ucFirstLowerRest(e[d]):e[d],l.push(Ti.UI.createPickerRow({title:n+"                                                        ",valor:e[d]})),c++;c>0&&t.add(l),Ti.API.debug(e==[]?"filling picker with  empty list":"filling picker with  "+e.length+" rows"),t.selectionIndicator=!0,o.setSelectedValue(""),t.addEventListener("change",function(e){o.setSelectedValue(e.row.valor),null!=o.onChangeEvent&&Ti.App.fireEvent(o.onChangeEvent)})},o.resetPicker(e),o};var a=" *",r=L("dropdown_select");MenuView=require("ui/common/MenuView");var i=new MenuView(L("home"));t.add(i);var o=Ti.UI.createScrollView({layout:"vertical"});t.add(o),t.scrollable=o;var n=L("provincia");o.add(t.createLabel(n+a)),t.arrayProvincies=Ti.App.dB.getProvinces();var l=t.createPicker(t.arrayProvincies,"onProvinceChanged",null,r+" "+n.toLowerCase());o.add(l);var c=L("poblacio");o.add(t.createLabel(c+a)),t.arrayCities=[];var d=t.createPicker(t.arrayCities,"onCityChanged",null,r+" "+c.toLowerCase());o.add(d),t.pickerPoblacio=d;var s=L("collegi_electoral");o.add(t.createLabel(s+a)),t.arrayCollegis=[];var u=t.createPicker(t.arrayCollegis,null,null,r+" "+s.toLowerCase());o.add(u),t.pickerColegi=u;var p=L("partit_afectat");o.add(t.createLabel(p+a)),t.arrayPartits=[L("all"),"Candidatura d'Unitat Popular - Alternativa d'Esquerres (CUP)","Ciutadans - Ciudadanos (Cs)","Convergència i Unió (CiU)","Escons en Blanc (EB)","Esquerra Republicana de Catalunya - Catalunya Sí (ERC)","Hartos.org (FARTS.CAT)","Iniciativa per Catalunya Verds (ICV-EUiA)","Partit Animalista Contra el Maltractament Animal (PACMA)","Partit Popular (PPC)","Partit Republicà d'Esquerres - Izquierda Republicana (PRE-IR)","Partit Socialista de Catalunya (PSC)","Pirates de Catalunya (PIRATA.CAT)","Plataforma per Catalunya (PxC)","Socialistes i Republicans - Pel dret a decidir (SiR)","Solidaritat Catalana (SI)","Unificación Comunista de España (UCE)","Unión, Progreso y Democracia (UPyD)","Vía Democrática (VD)"];var T=t.createPicker(t.arrayPartits,null,!0,r+" "+p.toLowerCase());o.add(T);var v=L("causa");o.add(t.createLabel(v+a));for(var g=[],b=1,h="causa"+b,C=L(h);C!=h&&null!=C;)g.push(C),b++,h="causa"+b,C=L(h,h);g.sort(),g.push(L("other_causes"));var P=t.createPicker(g,null,!0,r+" "+v.toLowerCase());o.add(P);var w=L("nom_del_reportador");o.add(t.createLabel(w+a));var f=t.createTextField(Ti.App.Properties.getString("reporter_name",""),"");o.add(f);var m=L("tel_reportador");o.add(t.createLabel(m+a));var I=t.createTextField(Ti.App.Properties.getString("reporter_phone",""),"");o.add(I),o.add(t.createLabel(L("comentaris")));var A=t.createTextField("","");o.add(A);var E=Ti.UI.createView({layout:"horizontal",height:50,bottom:10,top:10,right:10});o.add(E);var _=Ti.UI.createButton({height:55,width:"100",title:L("enviar"),left:10});E.add(_),t.actInd=Ti.UI.createActivityIndicator({height:50,width:150,color:"white",message:L("enviant")}),t.actInd.hide(),E.add(t.actInd),t.coords="unknown",t.isFormInvalid=function(){return""==T.valor||""==l.valor||""==d.valor||""==u.valor||""==P.valor||""==f.value||""==I.value},_.addEventListener("click",function(){if(t.isFormInvalid()){Ti.UI.createAlertDialog({message:L("error_validacio_report"),ok:"Ok",title:"Error"}).show()}else{t.actInd.show(),_.enabled=!1;var e=Titanium.Network.createHTTPClient();e.validatesSecureCertificate=!1,e.onload=function(){var e=JSON.parse(this.responseText),a=e.message;if(Ti.API.info("response is ",a),"OK"==a){var r=Ti.UI.createAlertDialog({message:L("report_enviat_ok"),buttonNames:["Ok",L("see_report")],title:L("enviat_titol")});r.addEventListener("click",function(e){1===e.index&&Titanium.Platform.openURL(Ti.App.Properties.getString("public_url"))}),r.show(),P.setSelectedRow(0,0),P.setSelectedValue(""),u.setSelectedRow(0,0),u.setSelectedValue(""),T.setSelectedRow(0,0),T.setSelectedValue("")}else var r=Ti.UI.createAlertDialog({message:L(a),ok:"Ok",title:"Error"}).show();t.actInd.hide(),_.enabled=!0,Ti.App.Properties.setString("reporter_name",f.value),Ti.App.Properties.setString("reporter_phone",I.value)},e.onerror=function(e){Ti.API.info("ERROR "+e.error);Ti.UI.createAlertDialog({message:L("send_report_error"),ok:"Ok",title:"Error"}).show();t.actInd.hide(),_.enabled=!0};var a=Titanium.App.Properties.getString("server_url")+"inserir.php";e.open("POST",a);var r={partit_afectat:T.valor,provincia:l.valor,poblacio:d.valor,coords:t.coords,deviceid:Ti.Platform.id,collegi_electoral:u.valor,causa:P.valor,reportador:f.value,contacte_reportador:I.value,comentari:A.value};e.send(r)}});var S=Ti.UI.createButton({height:55,width:"100",title:L("reset"),left:10});return"iPhone OS"==Titanium.Platform.name?o.add(S):E.add(S),S.addEventListener("click",function(){f.value="",I.value="",A.value="",T.setSelectedRow(0,0),T.setSelectedValue(""),l.setSelectedRow(0,0),l.setSelectedValue(""),Ti.App.fireEvent("onProvinceChanged"),P.setSelectedRow(0,0),P.setSelectedValue(""),Ti.App.Properties.setString("reporter_name",""),Ti.App.Properties.setString("reporter_phone","")}),t.addEventListener("focus",function(){Ti.Geolocation.locationServicesEnabled===!0&&(Ti.Geolocation.accuracy=Ti.Geolocation.ACCURACY_BEST,Ti.Geolocation.purpose=L("obtenir_posicio"),Ti.Geolocation.getCurrentPosition(function(e){if(e.success&&!e.error){var a=e.coords.longitude,r=e.coords.latitude,i=e.coords.accuracy;t.coords="long:"+a.toFixed(6)+",lat:"+r.toFixed(6)+",accuracy:"+i.toFixed(0)}}))}),Ti.App.addEventListener("onProvinceChanged",function(){t.arrayCities=""!=l.valor?Ti.App.dB.getCities(l.valor):[],d.resetPicker(t.arrayCities),Ti.App.fireEvent("onCityChanged")}),Ti.App.addEventListener("onCityChanged",function(){t.arrayCollegis=""!=d.valor?Ti.App.dB.getCollegis(d.valor):[],u.resetPicker(t.arrayCollegis)}),t}module.exports=ReportWindow;